{% extends 'base.html' %}

{% block title %}Розыгрыш PORSCHE CAYENNE - Регистрация{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Информация о призе -->
    <div class="col-lg-6">
        <div class="prize-card p-3">
            <div class="car-image-container position-relative mb-4">
                <img src="{{ url_for('static', filename='images/porsche-cayenne.png') }}?v=1" alt="Porsche Cayenne" class="car-image w-100">
            </div>
            <h3 class="feature-heading mb-4"><i class="fas fa-info-circle me-2"></i>Для участия в розыгрыше необходимо:</h3>
            <div class="car-specs mb-4">
                <!-- Призовые шаги -->
            </div>

            <h3 class="rules-heading"><i class="fas fa-gavel me-2"></i>Правила розыгрыша</h3>
            <ul class="rules-list">
                <li>Участвовать могут только жители Махачкалы (включая все районы, посёлки и сёла) и Каспийска</li>
                <li>Возраст участников должен быть не менее 16 лет</li>
                <li>Нельзя покидать сообщество до завершения розыгрыша</li>
                <li>Победитель будет выбран случайным образом</li>
            </ul>
        </div>
    </div>
    
    <!-- Форма регистрации -->
    <div class="col-lg-6">
        <div class="registration-card p-4">
            <h2 class="text-center mb-4"><i class="fas fa-user-plus me-2 text-primary"></i>Регистрация участника</h2>
            
            <div id="location-status" style="display: none;"></div>
            
            <form id="registration-form" action="/" method="post" class="registration-form">
                {{ form.hidden_tag() }}
                <input type="hidden" id="latitude" name="latitude" value="">
                <input type="hidden" id="longitude" name="longitude" value="">

                <!-- Фамилия и Имя -->
                <div class="form-group mb-3">
                    <label for="full_name" class="form-label"><i class="fas fa-user me-2"></i>Фамилия и Имя:</label>
                    <input type="text" class="form-control" id="full_name" name="full_name" required>
                </div>

                <!-- Номер телефона -->
                <div class="form-group mb-3">
                    <label for="phone" class="form-label"><i class="fas fa-phone-alt me-2"></i>Номер телефона:</label>
                    <input type="tel" class="form-control" id="phone" name="phone" placeholder="+7 (999) 999-99-99" required>
                </div>

                <!-- Возраст -->
                <div class="form-group mb-3">
                    <label for="age" class="form-label"><i class="fas fa-birthday-cake me-2"></i>Возраст:</label>
                    <input type="number" class="form-control" id="age" name="age" min="16" max="100" required>
                </div>

                <!-- Пол -->
                <div class="form-group mb-4">
                    <label class="form-label d-block"><i class="fas fa-venus-mars me-2"></i>Пол:</label>
                    <div class="gender-options d-flex">
                        <div class="form-check form-check-inline me-4">
                            <input class="form-check-input" type="radio" name="gender" id="male" value="male" required>
                            <label class="form-check-label" for="male">Мужской</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="gender" id="female" value="female">
                            <label class="form-check-label" for="female">Женский</label>
                        </div>
                    </div>
                </div>

                <!-- Кнопка отправки формы -->
                <button type="submit" id="submit-registration" class="btn btn-register btn-lg w-100">
                    <i class="fas fa-check-circle me-2"></i>Участвовать в розыгрыше
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для успешной регистрации -->
<div class="modal fade" id="registrationSuccessModal"  tabindex="-1" aria-labelledby="registrationSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style = "color: black; background-color:white;" >
            <div class="modal-header">
                <h5 class="modal-title" id="registrationSuccessModalLabel">Поздравляем!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы успешно зарегистрировались на розыгрыш от Камиля Вагидова!</p>
                <p>Ваш номерок для участия: <span id="participant-number"></span></p>
                <p>Следите за новостями на странице VK Камиля: <a href="https://vk.com/kamil_vagidov" target="_blank">ссылка</a></p>
                <p>Посмотрите видео с нашими предыдущими победителями.</p>
                <p id="countdown">Вы будете перенаправлены через 5 секунд...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для уже зарегистрированного номера -->
<div class="modal fade" id="alreadyRegisteredModal" tabindex="-1" aria-labelledby="alreadyRegisteredModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style = "color: black; background-color:white;" >
            <div class="modal-header">
                <h5 class="modal-title" id="alreadyRegisteredModalLabel">Ваш номер уже зарегистрирован</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Ваш номер телефона уже зарегистрирован в системе. Это и есть номерок для участия в розыгрыше!</p>
                <p>Следите за новостями на странице VK Камиля: <a href="https://vk.com/kamil_vagidov" target="_blank">ссылка</a></p>
                <p>Посмотрите видео с нашими предыдущими победителями.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

{% if is_registered is not none %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('is_registered:', '{{ is_registered }}'); // Отладка
            var modalId = '{{ is_registered }}';
            var modalElement = document.querySelector(modalId);
            if (modalElement) {
                var modal = new bootstrap.Modal(modalElement);
                modal.show();

                if (modalId === '#registrationSuccessModal') {
                    var countdownElement = document.getElementById('countdown');
                    var seconds = 5;
                    var countdown = setInterval(function() {
                        seconds--;
                        countdownElement.textContent = `Вы будете перенаправлены через ${seconds} секунд...`;
                        if (seconds <= 0) {
                            clearInterval(countdown);
                            window.location.href = "https://chat.whatsapp.com/D5YlUS1y9MIKkIB3oq8Vh8";
                        }
                    }, 1000);
                }
            } else {
                console.error('Модальное окно не найдено:', modalId);
            }
        });
    </script>
{% endif %}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.7/dist/inputmask.min.js"></script>
<script>
    var phoneMask = new Inputmask('+7 (999) 999-99-99');
    phoneMask.mask(document.getElementById('phone'));

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                document.getElementById('latitude').value = position.coords.latitude;
                document.getElementById('longitude').value = position.coords.longitude;
                console.log('Геолокация обновлена:', {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                });
            }, function(error) {
                document.getElementById('location-status').style.display = 'block';
                document.getElementById('location-status').innerText = "Не удалось получить местоположение.";
            }, {
                enableHighAccuracy: true, // Высокая точность
                timeout: 5000, // Таймаут 5 секунд
                maximumAge: 0 // Не использовать кэшированные данные
            });
        } else {
            alert('Геолокация не поддерживается этим браузером.');
        }
    }

    document.getElementById('registration-form').addEventListener('submit', function(e) {
        e.preventDefault();
        getLocation();
        setTimeout(function() {
            document.getElementById('registration-form').submit();
        }, 1000);
    });

    window.onload = getLocation;
</script>
{% endblock %}
